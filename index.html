<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Camera Rear Detection — Test & Force Rear</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#071021;color:#e8f6ff;padding:12px;display:flex;flex-direction:column;gap:10px;align-items:center}
  .card{background:#071827;border-radius:10px;padding:12px;max-width:920px;width:96%}
  h2{margin:0 0 6px 0;font-size:16px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  select,button,input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#06202a;color:#e6f6ff}
  button{font-weight:700;cursor:pointer}
  button:disabled{opacity:.45;cursor:not-allowed}
  video{width:100%;max-width:560px;border-radius:8px;background:#000}
  pre{background:#02121a;padding:8px;border-radius:6px;color:#9fd8e5;overflow:auto}
  .small{font-size:13px;color:#9fb6c2}
</style>
</head>
<body>
  <div class="card">
    <h2>Rear camera detection & test</h2>
    <div class="row" style="margin-bottom:8px;">
      <button id="btnGrant">Grant Camera Permission (recommended)</button>
      <button id="btnEnumerate">Refresh List</button>
      <button id="btnDetect">Detect Rear by Testing Devices</button>
      <button id="btnForceFacing">Start Using facingMode:environment</button>
      <button id="btnStop" disabled>Stop Stream</button>
    </div>

    <div class="row" style="gap:10px;margin-bottom:8px;">
      <label class="small">Available video inputs:</label>
      <select id="deviceList" style="min-width:220px"></select>
      <button id="btnStartSelected">Start Selected</button>
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <video id="preview" autoplay playsinline muted></video>
      <div style="flex:1;min-width:220px">
        <div class="small" id="status">Status: idle</div>
        <pre id="log" style="height:220px">Log will appear here — use Detect Rear to test devices.</pre>
      </div>
    </div>
    <div style="margin-top:8px" class="small">
      Tips: run on HTTPS / localhost. If you use iOS Safari it may not expose multiple deviceIds — use "Start Using facingMode:environment" or try Chrome on Android for better hardware selection.
    </div>
  </div>

<script>
(async ()=>{
const btnGrant = document.getElementById('btnGrant');
const btnEnumerate = document.getElementById('btnEnumerate');
const btnDetect = document.getElementById('btnDetect');
const btnForceFacing = document.getElementById('btnForceFacing');
const btnStop = document.getElementById('btnStop');
const deviceList = document.getElementById('deviceList');
const btnStartSelected = document.getElementById('btnStartSelected');
const preview = document.getElementById('preview');
const logEl = document.getElementById('log');
const status = document.getElementById('status');

let lastStream = null;
function log(...args){ logEl.textContent = new Date().toLocaleTimeString() + '  ' + args.join(' ') + '\n' + logEl.textContent; }
function setStatus(t){ status.textContent = 'Status: ' + t; }

/* ensure permissions are requested so labels become visible */
btnGrant.addEventListener('click', async ()=>{
  try{
    setStatus('Requesting camera permission...');
    const s = await navigator.mediaDevices.getUserMedia({ video: true, audio:false });
    s.getTracks().forEach(t=>t.stop());
    setStatus('Permission granted (temporary). Now Refresh list.');
    log('Temporary permission granted — device labels should now appear.');
  }catch(e){
    setStatus('Permission denied or error: ' + (e.message||e.name));
    log('Permission error: ' + (e.message||e.name));
    alert('Permission denied — allow camera in browser to list devices.');
  }
});

/* enumerate videoinputs and prioritize likely rear labels */
async function enumerateDevices(){
  try{
    const devices = await navigator.mediaDevices.enumerateDevices();
    const vids = devices.filter(d=>d.kind==='videoinput');
    deviceList.innerHTML = '';
    const rearTokens = ['back','rear','environment','wide','main','ultra','tele','camera_0'];
    // sort: rear-token first
    vids.sort((a,b)=>{
      const la = (a.label||'').toLowerCase(); const lb = (b.label||'').toLowerCase();
      const sa = rearTokens.some(t=>la.includes(t)) ? 0 : 1;
      const sb = rearTokens.some(t=>lb.includes(t)) ? 0 : 1;
      return sa - sb;
    });
    vids.forEach((d,i)=> {
      const opt = document.createElement('option');
      opt.value = d.deviceId;
      opt.textContent = d.label || `Camera ${i+1}`;
      deviceList.appendChild(opt);
    });
    setStatus(`Found ${vids.length} video input(s).`);
    log('Enumerated devices: ' + vids.map(v=>v.label || v.deviceId).join(' | '));
  }catch(e){
    setStatus('enumeration failed: ' + (e.message||e.name));
    log('enumeration error: ' + (e.message||e.name));
  }
}
btnEnumerate.addEventListener('click', ()=> enumerateDevices());

/* utility: start a tiny stream with constraints and immediately stop (used for testing) */
async function testDeviceId(deviceId, timeoutMs=3000){
  // try to open deviceId-only stream (no facingMode) to inspect track settings/label
  try{
    const constraints = { video: { deviceId: { exact: deviceId } }, audio:false };
    const s = await navigator.mediaDevices.getUserMedia(constraints);
    const track = s.getVideoTracks()[0];
    // read settings and label (label may still be empty on some browsers)
    const settings = track.getSettings ? track.getSettings() : {};
    const label = track.label || (s.active ? (s.getTracks()[0] && s.getTracks()[0].label) : '');
    // facingMode might be available in settings
    const facing = settings.facingMode || settings.deviceId ? settings.facingMode : undefined;
    // stop quickly
    s.getTracks().forEach(t=>t.stop());
    return { ok:true, facing: facing || null, label: label || null, settings };
  }catch(err){
    return { ok:false, error: err && (err.name||err.message) || String(err) };
  }
}

/* try each deviceId and report which one looks like rear */
btnDetect.addEventListener('click', async ()=>{
  setStatus('Detecting rear camera by testing each device — this may take a few seconds...');
  log('--- Starting detection run ---');
  await enumerateDevices(); // refresh list
  const options = Array.from(deviceList.options).map(o=>({deviceId:o.value, label:o.text}));
  if(!options.length){ setStatus('No video inputs found. Grant permission first.'); return; }
  const rearTokens = ['back','rear','environment','wide','main','ultra','tele','camera_0'];
  let found = null;
  for(const opt of options){
    setStatus('Testing device: ' + (opt.label || opt.deviceId));
    log('Testing: ' + (opt.label || opt.deviceId));
    // attempt test
    const res = await testDeviceId(opt.deviceId);
    if(!res.ok){
      log(`Test failed for ${opt.label}: ${res.error}`);
      continue;
    }
    log(`Test OK — facing:${res.facing} label:"${res.label}" settings:${JSON.stringify(res.settings)}`);
    // heuristic: if settings.facingMode == 'environment' OR label contains rear token => choose it
    const la = (res.label||'').toLowerCase();
    if((res.facing && res.facing.toLowerCase().includes('environment')) || rearTokens.some(t=>la.includes(t))){
      found = opt;
      log('Selected as rear by heuristic: ' + (opt.label || opt.deviceId));
      break;
    }
  }
  if(found){
    // fill select and start stream with that deviceId
    deviceList.value = found.deviceId;
    setStatus('Rear candidate found: ' + found.label + ' — starting it.');
    log('Starting candidate device stream...');
    await startStreamWithDevice(found.deviceId);
  }else{
    setStatus('No device identified confidently as rear. Use "Try Rear (facingMode)" to force environment camera.');
    log('No rear candidate found. Try "Try Rear (facingMode)".');
  }
});

/* start stream for a chosen deviceId (keeps it open in preview) */
async function startStreamWithDevice(deviceId){
  try{
    if(lastStream){ lastStream.getTracks().forEach(t=>t.stop()); lastStream=null; preview.srcObject=null; }
    setStatus('Opening device: ' + deviceId);
    const s = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: deviceId }, width: { ideal: 4000 }, height: { ideal: 3000 } }, audio:false });
    lastStream = s;
    preview.srcObject = s;
    btnStop.disabled = false;
    log('Stream started for deviceId: ' + deviceId);
  }catch(e){
    log('Failed to open device stream: ' + (e && (e.name||e.message) || e));
    setStatus('Stream failed: ' + (e && (e.name||e.message) || e));
    alert('Could not open selected camera. Try "Try Rear (facingMode)" or refresh devices.');
  }
}

/* Start selected device from dropdown */
btnStartSelected.addEventListener('click', async ()=>{
  const id = deviceList.value;
  if(!id){ alert('No device selected'); return; }
  await startStreamWithDevice(id);
});

/* Start using facingMode:environment (fallback) */
btnForceFacing.addEventListener('click', async ()=>{
  try{
    if(lastStream){ lastStream.getTracks().forEach(t=>t.stop()); lastStream=null; preview.srcObject=null; }
    setStatus('Starting camera with facingMode: environment (fallback)');
    const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' }, width:{ ideal: 4000 }, height:{ ideal: 3000 } }, audio:false });
    lastStream = s;
    preview.srcObject = s;
    btnStop.disabled = false;
    log('Started stream with facingMode: environment. Note: some browsers ignore facingMode.');
  }catch(e){
    log('facingMode start failed: ' + (e && (e.name||e.message) || e));
    setStatus('facingMode request failed: ' + (e && (e.name||e.message) || e));
    alert('Could not start environment-facing stream. Your browser may limit camera selection (iOS Safari is known to do this). Try Chrome on Android if possible.');
  }
});

/* Stop */
btnStop.addEventListener('click', ()=>{
  if(lastStream) lastStream.getTracks().forEach(t=>t.stop());
  lastStream = null;
  preview.srcObject = null;
  btnStop.disabled = true;
  setStatus('Stream stopped');
  log('Stream stopped by user.');
});

/* initial enumeration */
await enumerateDevices();
setStatus('Ready. Press "Grant Camera Permission" if rear camera still not listed.');
})();
</script>
</body>
</html>
